---
title: Mysql排错指南
tags: sql
grammar_cjkRuby: true
---

- 当我们发现不同mysql的版本，有的版本能执行sql有的不能，则可能是mysql不同版本之间有不同的关键字，在给关键字字段加上引号（反引号）。
- 在检查复杂sql问题时，可以先把sql修改的简单一些，再查看那些sql出错。
- 执行语句的时候可以 EXPLAIN EXTENDED 语句之后，通过 SHOW WARNINGS 命令展示的就是优化后的查询。
	![查询运行异常方法][1]
	
- 删除更新操作如果出现问题可以，where条件不变，通过select查询其影响的值
- 在主从复制的集群中，避免使用临时表，因为这样如果服务器重启，就会导致临时表的删除，导致同步不及时的数据出现问题。
- 在与WHERE、JOIN、GROUP BY和ORDER BY语句相关的列上添加索引可以加速查询
- 表损坏可能表现为查询执行错误或者服务器停止。在MyISAM 引擎下查看错误消息是否有`repair` 或 `crashed`来判断是否是表损坏，InnoDB引擎 如果有数据损坏，则有可能是磁盘或内存有问题
- 当遇到权限的问题时，如果可以连接到数据库可以通过USER()、CURRENT_USRE()函数和select user,host from mysql.user order by host desc 来查询用户的权限，这种问题的发生一般原因是授权的时候有通配符授权。当连接不上服务器是，可以看下错误日志。user()函数会返回当前用户连接到服务器时使用的连接参数，通常为指定的用户名和运行客户端的主机名。current_user()函数会返回从权限表中选择的与访问权限相关的用户名和主机名对
- InnoDB引擎用简写的S代表读锁/共享锁，用X代表写锁/排它锁
- 执行SHOW ENGINE INNODB STATUS命令，可以监测InnoDB监控器.
- mysql 查看数据库是否自动提交事务，可以通过`show variables like 'autocommit'`来查看，设置其值时，可以通过`set autocommit = off`来关闭自动提交
- 隐式提交，在新建表时（用create table 命令），其会隐式提交sql，即使你autocommit设置为off，也不行
- mysql事务只有在提交的时候才向二进制日志中写入数据。
- 不要把事务表和非事务表混合在一个事务中。
- 怀疑字符集与排序规则有错误的时候，通常获取所有的`character_set_*` 变量、`collation_*`变量，并创建选项相同的任何表与一起协同工作的连接。设置客户端选项最简单方式是用`SET NAMES`语句。
- `lower_case_filesystem`与`lower_case_table_names`选项跟字符集选项的作用非常相似，最好不要修改它们的值。
- mysqldumpslow 工具可以以一种汇总格式输出慢查询日志中的内容。它将查询进行分组，所以如果两条查询字面上相同，但使用不同的参数，它们与执行次数只输出一次。

### Show [GLOBAL] STATUS
> 特定类型的状态变量

- `Com_*`状态变量：这些变量包含的数量执行的各种类型。例如。Com_select显示有多少SELECT查询执行，Com_begin显示有多少事务开始
- `Handler_*`、`Select_*`、`Sort_*`变量
	- `Handle_*`变量显示当查询执行时，表内部发生了什么。例如`Handler_delete`显示实际上有多少行被删除。
	- `Select_*`变量显示使用到的不同连接的数码。
	- `Sort_*`变量显示关于排序的信息。它们能帮你找到你的查询在性能方面的效果如何。
	- `Innodb_*`变量：显示InnoDB存储引擎的内部状态。
	- `Performance_schema_*`变量：提供关于“监测点”对象的信息
	- `Ssl_*`变量：显示关于SSL连接统计信息。
	- `*open*`和`*create*`变量：包含这些关键字的变量显示有多少不同类型的对象被打开或关闭


### 故障排除的一般步骤

1. 尝试确定造成问题的实际查询
2. 检查以确保查询的语法正确
3. 确认查询里有问题
4. 如果查询返回错误数据时，请其尝试重写它以得到正确的结果，期望的结果
5. 如果重写没有帮助，你可以检查服务器选项并尝试确定他们是否影响结果
6. 如果你确定查询是正确的，当查询执行时，请向后查找知道找到损坏数据的一个语句或动作
7. 如果问题不能在Mysql CLI重现，请检查他是否是并发问题
8. 如果该问题会导致系统崩溃或挂起，首先检查错误日志
9. 如果错误日志文件不能给出一些线索，请试着找到崩溃前的最后查询
		- 使用musqld-debug，从发生故障的服务器中产生核心文件，然后分析它
		- 分析并调整配置选项
		- 利用操作系统工具来找到那些影响musqld的外部进程。


### 工具
- 可以根据perror 查询mysql错误码代表的具体含义。`perror 1146`
- 基准工具 
	- musqlslap，负载模拟客户端
	- SysBench 它可以用来测量整个系统的性能，包括测试CPU、文件I/O、操作系统调度程序、POSIX线程性能、内存分配、传输速度与数据库服务器性能
- Gypsy：负载测试工具


### 建议
1.可以通过指定表名.列名的格式指定完整的列名，避免选取的表字段错误。
2.检查表中是否存在一条数据，推荐用Max() 方法，比count()方法要快。

  [1]: https://www.github.com/COBSNAN/ImageHub/raw/master/1520864213442.jpg